// This file defines all database tables using Prisma ORM
// Run `npm run db:push` to sync with your database

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url = env("DATABASE_URL")
}

// NextAuth.js Required Tables
// Do not modify the field names as NextAuth expects these exact names

model User {
  id            String    @id @default(cuid())
  name          String?
  email         String?   @unique
  emailVerified DateTime?
  image         String?

  // GitHub-specific fields we add
  githubId      Int?      @unique
  githubLogin   String?   // GitHub username (e.g., "octocat")

  // Timestamps
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  // Relations
  accounts      Account[]
  sessions      Session[]
  repositories  Repository[]
  settings      UserSettings?

  @@map("users")
}

model Account {
  id                String  @id @default(cuid())
  userId            String
  type              String
  provider          String
  providerAccountId String

  // OAuth tokens
  // access_token lets us call GitHub API on behalf of the user
  refresh_token     String? @db.Text
  access_token      String? @db.Text
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String? @db.Text
  session_state     String?

  // Timestamps
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  // Relations
  user              User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
  @@map("accounts")
}

model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique
  userId       String
  expires      DateTime

  // Relations
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("sessions")
}

model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
  @@map("verification_tokens")
}

// Application Tables

model Repository {
  id          String   @id @default(cuid())
  userId      String

  // GitHub data
  githubId    Int
  name        String
  fullName    String
  owner       String
  isPrivate   Boolean  @default(false)

  // Tracking status
  isTracked   Boolean  @default(true)

  // Timestamps
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relations
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  pullRequests PullRequest[]

  // User can't track same repo twice
  @@unique([userId, githubId])
  @@map("repositories")
}

model PullRequest {
  id              String    @id @default(cuid())
  repositoryId    String

  // GitHub data
  githubId        Int
  number          Int
  title           String
  url             String

  // Author info
  authorLogin     String
  authorAvatar    String?

  // Reviewers (stored as JSON array of usernames)
  requestedReviewers String[]

  // Status tracking
  status          PullRequestStatus @default(OPEN)
  isDraft         Boolean   @default(false)

  // Labels (stored as JSON array)
  labels          String[]  // e.g., ["bug", "critical", "hotfix"]

  // Important timestamps for analytics
  prCreatedAt     DateTime
  prUpdatedAt     DateTime
  firstReviewedAt DateTime?
  mergedAt        DateTime?
  closedAt        DateTime?

  // Our timestamps
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  // Relations
  repository      Repository @relation(fields: [repositoryId], references: [id], onDelete: Cascade)
  reminders       Reminder[]

  // Can't have duplicate PRs per repo
  @@unique([repositoryId, githubId])
  @@map("pull_requests")
}

enum PullRequestStatus {
  OPEN
  MERGED
  CLOSED
}

model Reminder {
  id            String    @id @default(cuid())
  pullRequestId String

  // Reminder details
  type          ReminderType
  scheduledFor  DateTime
  sentAt        DateTime?

  // Who to remind
  recipientLogin String

  // Notification tracking
  notificationChannel NotificationChannel
  notificationSent    Boolean @default(false)

  // Timestamps
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  // Relations
  pullRequest   PullRequest @relation(fields: [pullRequestId], references: [id], onDelete: Cascade)

  @@map("reminders")
}

enum ReminderType {
  FIRST       // First gentle nudge (e.g., after 24h)
  SECOND      // Second reminder (e.g., after 48h)
  ESCALATION  // Escalate to team lead (e.g., after 72h)
}

enum NotificationChannel {
  SLACK
  DISCORD
  EMAIL
}

model UserSettings {
  id        String @id @default(cuid())
  userId    String @unique

  // Reminder configuration
  reminderEnabled     Boolean @default(true)
  firstReminderHours  Int     @default(24)
  secondReminderHours Int     @default(48)
  escalationHours     Int     @default(72)

  // Notification channels
  slackWebhookUrl     String?
  discordWebhookUrl   String?
  emailEnabled        Boolean @default(false)

  // Quiet hours (don't send reminders during these times)
  quietHoursEnabled   Boolean @default(true)
  quietHoursStart     Int     @default(18)
  quietHoursEnd       Int     @default(9)
  quietHoursTimezone  String  @default("UTC")
  weekendsEnabled     Boolean @default(false)

  // Priority settings
  juniorAuthors       String[] // GitHub usernames to prioritize
  criticalLabels      String[] @default(["critical", "hotfix", "urgent"])

  // Timestamps
  createdAt           DateTime @default(now())
  updatedAt           DateTime @updatedAt

  // Relations
  user                User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("user_settings")
}
